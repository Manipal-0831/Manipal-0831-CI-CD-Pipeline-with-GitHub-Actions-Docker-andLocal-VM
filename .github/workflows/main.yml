- name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: '3.11'

  - name: Install Dependencies
    run: pip install -r requirements.txt

  - name: Run Pytest Tests
    # The exit code determines if this job passes or fails
    run: pytest
- name: Log in to Docker Hub
    # Uses secrets for security
    uses: docker/login-action@v3
    with:
      username: ${{ env.DOCKER_HUB_USERNAME }}
      password: ${{ secrets.DOCKER_PASSWORD }}

  - name: Build and Push Docker image (with SHA tag)
    uses: docker/build-push-action@v5
    with:
      context: .
      push: true
      tags: |
        ${{ env.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        ${{ env.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
      # Pass the commit SHA as an environment variable into the image itself
      build-args: |
        APP_VERSION=${{ env.IMAGE_TAG }}

  - name: Output Docker Image Link
    run: |
      echo "Successfully pushed image to Docker Hub:"
      echo "https://hub.docker.com/r/${{ env.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}"
